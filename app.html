<!DOCTYPE html>
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                     üí∞ GESTOR FINANCEIRO PESSOAL                             ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Desenvolvedor: Otavio Silva                                                ‚ïë
‚ïë  Email: otavio.silva1661@gmail.com                                          ‚ïë
‚ïë  WhatsApp: (44) 99734-1687                                                  ‚ïë
‚ïë  GitHub: https://github.com/Otavio1661                                     ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Descri√ß√£o: Sistema completo de controle financeiro pessoal com interface   ‚ïë
‚ïë             moderna, armazenamento em arquivos XLSX locais e visualiza√ß√µes  ‚ïë
‚ïë             gr√°ficas avan√ßadas.                                             ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Vers√£o: 1.0.0                                                              ‚ïë
‚ïë  Data: Janeiro 2026                                                         ‚ïë
‚ïë  Licen√ßa: MIT License                                                       ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Copyright (c) 2026 Otavio Silva                                            ‚ïë
‚ïë  Todos os direitos reservados sob a Licen√ßa MIT                             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="author" content="Otavio Silva" />
  <meta name="description" content="Sistema de controle financeiro pessoal - Desenvolvido por Otavio Silva" />
  <title>Controle Financeiro - by Otavio Silva</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.14.1/dist/sweetalert2.min.css" rel="stylesheet" />
  <style>
    :root{ 
      --primary:#1a1d29; 
      --primary-dark:#0f1117; 
      --secondary:#2d3142;
      --accent:#4a90e2;
      --success:#10b981; 
      --danger:#ef4444; 
      --warning:#f59e0b;
      --text-primary:#e5e7eb;
      --text-secondary:#9ca3af;
      --bg-dark:#0f1117;
      --bg-card:#1a1d29;
      --border:#2d3142;
    }
    * { box-sizing: border-box; }
    body{
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; 
      background: var(--bg-dark);
      background-image: 
        radial-gradient(at 0% 0%, rgba(74, 144, 226, 0.1) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.08) 0px, transparent 50%);
      min-height:100vh; 
      padding:24px;
      color: var(--text-primary);
    }
    .container-xl{max-width:1400px; margin: 0 auto;}
    
    .header-card{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border: 1px solid var(--border);
      color:#fff; 
      padding:32px; 
      border-radius:16px; 
      box-shadow: 0 20px 40px rgba(0,0,0,.4), 0 0 1px rgba(255,255,255,.1) inset;
      backdrop-filter: blur(10px);
    }
    .header-card h1 { 
      font-weight: 700; 
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }
    .header-card p { 
      color: var(--text-secondary); 
      font-size: 0.95rem;
    }
    
    .stats .card{
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-left: 4px solid transparent;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stats .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,.4);
    }
    .stats .entradas{border-left-color:var(--success)}
    .stats .saidas{border-left-color:var(--danger)}
    .stats .saldo{border-left-color:var(--accent)}
    .stats .card > div:first-child {
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    .stats .value{
      font-size:2rem; 
      font-weight:700;
      font-variant-numeric: tabular-nums;
    }
    
    .content-card{
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius:16px; 
      padding:28px; 
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
      backdrop-filter: blur(10px);
    }
    
    .form-label { 
      color: var(--text-secondary); 
      font-weight: 500;
      font-size: 0.875rem;
      margin-bottom: 6px;
    }
    .form-control, .form-select {
      background: var(--primary-dark);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 8px;
      padding: 10px 14px;
      transition: all 0.2s;
    }
    .form-control:focus, .form-select:focus {
      background: var(--bg-card);
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
      color: var(--text-primary);
      outline: none;
    }
    .form-control::placeholder {
      color: var(--text-secondary);
      opacity: 0.6;
    }
    
    .btn {
      font-weight: 600;
      border-radius: 8px;
      padding: 10px 20px;
      transition: all 0.2s;
      border: none;
      text-transform: none;
    }
    .btn-primary {
      background: var(--accent);
      color: white;
      border: 1px solid rgba(74, 144, 226, 0.3);
    }
    .btn-primary:hover {
      background: #357ABD;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
    }
    .btn-secondary {
      background: var(--secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      background: #3d4252;
      color: white;
    }
    .btn-outline-primary, .btn-outline-success, .btn-outline-warning, .btn-outline-dark, .btn-outline-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-primary);
    }
    .btn-outline-primary:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .btn-outline-success:hover {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    .btn-outline-warning:hover {
      background: var(--warning);
      border-color: var(--warning);
      color: white;
    }
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }
    
    .badge {
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      letter-spacing: 0.025em;
    }
    .text-bg-info {
      background: var(--accent) !important;
      color: white !important;
    }
    .text-bg-secondary {
      background: var(--secondary) !important;
      color: var(--text-secondary) !important;
    }
    
    .categoria-badge{
      display:inline-block; 
      padding:4px 12px; 
      border-radius:6px; 
      background: var(--secondary);
      color: var(--text-primary);
      font-weight:600; 
      font-size:.8rem;
      border: 1px solid var(--border);
    }
    
    .nav-tabs {
      border-bottom: 2px solid var(--border);
      margin-bottom: 24px;
    }
    .nav-tabs .nav-link {
      color: var(--text-secondary);
      border: none;
      border-bottom: 2px solid transparent;
      padding: 12px 20px;
      font-weight: 500;
      transition: all 0.2s;
      background: transparent;
    }
    .nav-tabs .nav-link:hover {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: rgba(74, 144, 226, 0.05);
    }
    .nav-tabs .nav-link.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: transparent;
      font-weight: 600;
    }
    
    .table {
      color: var(--text-primary);
      border-color: var(--border);
    }
    .table thead {
      background: var(--primary);
      color: #e5e7eb;
      border: none;
    }
    .table thead th {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      padding: 14px 12px;
      border: none;
    }
    .table tbody tr {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }
    .table tbody tr:hover {
      background: var(--secondary);
    }
    .table tbody td {
      padding: 14px 12px;
      border-color: var(--border);
      vertical-align: middle;
      color: #141414;
    }
    .table tbody td strong {
      color: #141414;
      font-weight: 600;
    }
    .table tfoot th {
      background: var(--secondary);
      font-weight: 700;
      padding: 14px 12px;
      border-top: 2px solid var(--border);
      color: var(--text-primary);
    }
    .table-striped tbody tr:nth-of-type(odd) {
      background: rgba(45, 49, 66, 0.3);
    }
    .table-dark, .table-info, .table-primary {
      --bs-table-bg: var(--primary);
      --bs-table-color: #e5e7eb;
    }
    
    #tabelaLancamentos {
      border-radius: 12px;
      overflow: hidden;
    }
    #tabelaLancamentos thead{background:var(--primary); color:#e5e7eb; border: none;}
    #tabelaLancamentos thead th:first-child {
      border-top-left-radius: 12px;
    }
    #tabelaLancamentos thead th:last-child {
      border-top-right-radius: 12px;
    }
    .cell-entrada{background:rgba(16, 185, 129, 0.12) !important; color: #6ee7b7 !important; font-weight:600}
    .cell-saida{background:rgba(239, 68, 68, 0.12) !important; color: #fca5a5 !important; font-weight:600}
    .saldo-neg{color:var(--danger) !important; font-weight:700}
    .saldo-pos{color:var(--success) !important; font-weight:700}
    .text-success { color: var(--success) !important; }
    .text-danger { color: var(--danger) !important; }
    .text-primary { color: var(--accent) !important; }
    .text-muted { color: var(--text-secondary) !important; }
    
    .chart-wrap{
      position:relative; 
      height:320px;
      background: var(--primary-dark);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--border);
    }
    
    .table-responsive {
      border-radius: 8px;
      overflow: hidden;
    }
    
    small, .small {
      color: var(--text-secondary);
    }
    
    /* DataTables overrides */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
      color: var(--text-secondary);
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button {
      color: var(--text-primary) !important;
      background: var(--secondary);
      border: 1px solid var(--border);
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
      color: white !important;
      background: var(--accent) !important;
      border-color: var(--accent) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
      color: white !important;
      background: var(--accent) !important;
      border-color: var(--accent) !important;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-track {
      background: var(--primary-dark);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--secondary);
    }
  </style>
</head>
<body>
  <div class="container-xl">
    <div class="header-card mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-lg-6">
          <h1 class="h3 mb-1"><i class="bi bi-wallet2"></i> Controle Financeiro</h1>
          <p class="mb-0">Gest√£o de receitas e despesas por m√™s/ano com planilha por m√™s</p>
          <p class="mb-0 mt-1"><small class="text-muted">Desenvolvido por <a href="https://github.com/Otavio1661" target="_blank" class="text-muted text-decoration-none">Ot√°vio Silva</a> ¬© 2026</small></p>
        </div>
        <div class="col-lg-6">
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label small">M√™s</label>
              <select id="monthSelect" class="form-select form-select-lg">
                <option value="01">Janeiro</option><option value="02">Fevereiro</option><option value="03">Mar√ßo</option>
                <option value="04">Abril</option><option value="05">Maio</option><option value="06">Junho</option>
                <option value="07">Julho</option><option value="08">Agosto</option><option value="09">Setembro</option>
                <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label small">Ano</label>
              <select id="yearSelect" class="form-select form-select-lg"></select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 stats mb-4">
      <div class="col-lg-4 col-md-6">
        <div class="card entradas p-3">
          <div class="text-success"><i class="bi bi-arrow-down-left-circle-fill"></i> Entradas</div>
          <div id="totalEntradas" class="value text-success">R$ 0,00</div>
        </div>
      </div>
      <div class="col-lg-4 col-md-6">
        <div class="card saidas p-3">
          <div class="text-danger"><i class="bi bi-arrow-up-right-circle-fill"></i> Sa√≠das</div>
          <div id="totalSaidas" class="value text-danger">R$ 0,00</div>
        </div>
      </div>
      <div class="col-lg-4 col-md-12">
        <div class="card saldo p-3">
          <div class="text-primary"><i class="bi bi-piggy-bank-fill"></i> Saldo</div>
          <div id="saldoFinal" class="value">R$ 0,00</div>
        </div>
      </div>
    </div>

    <div class="content-card mb-4">
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
        <h2 class="h5 mb-0"><i class="bi bi-plus-circle"></i> Novo lan√ßamento</h2>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-outline-warning" id="btnFolder"><i class="bi bi-folder2-open"></i> salvar</button>
          <span id="folderStatus" class="align-self-center small text-muted"></span>
          <span id="scopeStatus" class="align-self-center small badge rounded-pill text-bg-info">M√™s</span>
          <button class="btn btn-secondary" id="btnAtualizar"><i class="bi bi-arrow-clockwise"></i> Atualizar</button>
          <button class="btn btn-outline-primary" id="btnExportar"><i class="bi bi-download"></i> Exportar XLSX</button>
          <button class="btn btn-outline-success" id="btnExportarCategoria"><i class="bi bi-pie-chart"></i> Exportar por Categoria</button>
          <label class="btn btn-outline-dark mb-0" for="inputImportar"><i class="bi bi-upload"></i> Importar XLSX</label>
          <input type="file" id="inputImportar" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" hidden />
        </div>
      </div>
      <form id="formLancamento" class="row g-3">
        <div class="col-md-2">
          <label class="form-label">Data *</label>
          <input type="date" id="data" class="form-control" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">Descri√ß√£o *</label>
          <input type="text" id="descricao" class="form-control" placeholder="Ex: Sal√°rio, Aluguel..." required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Categoria *</label>
          <select id="categoria" class="form-select" required>
            <option value="">Selecione...</option>
            <option>Sal√°rio</option>
            <option>Receita Extra</option>
            <option>Moradia</option>
            <option>Alimenta√ß√£o</option>
            <option>Transporte</option>
            <option>Sa√∫de</option>
            <option>Lazer</option>
            <option>Educa√ß√£o</option>
            <option>Cart√£o de Cr√©dito</option>
            <option>Cart√£o de D√©bito</option>
            <option>Outros</option>
          </select>
        </div>
        <div class="col-md-1">
          <label class="form-label">Entrada</label>
          <input type="number" id="entrada" class="form-control" min="0" step="0.01" placeholder="0,00" />
        </div>
        <div class="col-md-1">
          <label class="form-label">Sa√≠da</label>
          <input type="number" id="saida" class="form-control" min="0" step="0.01" placeholder="0,00" />
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <button class="btn btn-primary w-100" type="submit"><i class="bi bi-check2-circle"></i> Adicionar</button>
        </div>
      </form>
    </div>

    <div class="content-card">
      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabLanc" type="button"><i class="bi bi-table"></i> Lan√ßamentos</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabResumo" type="button"><i class="bi bi-list-ul"></i> Resumo por categoria</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabCats" type="button"><i class="bi bi-tags"></i> Categorias</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPivot" type="button"><i class="bi bi-grid-3x3"></i> Pivot</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabGraficos" type="button"><i class="bi bi-graph-up"></i> Gr√°ficos</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabAno" type="button"><i class="bi bi-calendar2-range"></i> Ano / Geral</button>
        </li>
      </ul>

      <div class="tab-content pt-3">
        <div class="tab-pane fade show active" id="tabLanc">
          <div class="table-responsive">
            <table id="tabelaLancamentos" class="table table-striped table-hover" style="width:100%">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Descri√ß√£o</th>
                  <th>Categoria</th>
                  <th>Entrada (+)</th>
                  <th>Sa√≠da (-)</th>
                  <th>Saldo</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tbodyLanc"></tbody>
              <tfoot>
                <tr>
                  <th colspan="3" class="text-end">Totais:</th>
                  <th class="text-end text-success" id="ftLancEntrada">R$ 0,00</th>
                  <th class="text-end text-danger" id="ftLancSaida">R$ 0,00</th>
                  <th class="text-end fw-bold" id="ftLancSaldo">R$ 0,00</th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div class="tab-pane fade" id="tabResumo">
          <div class="table-responsive">
            <table class="table table-bordered table-striped" id="tabelaResumo">
              <thead class="table-dark">
                <tr>
                  <th>Categoria</th>
                  <th>Total Entradas</th>
                  <th>Total Sa√≠das</th>
                  <th>Diferen√ßa</th>
                </tr>
              </thead>
              <tbody id="tbodyResumo"></tbody>
              <tfoot>
                <tr>
                  <th class="text-end">Totais:</th>
                  <th class="text-end text-success" id="ftResumoEntrada">R$ 0,00</th>
                  <th class="text-end text-danger" id="ftResumoSaida">R$ 0,00</th>
                  <th class="text-end fw-bold" id="ftResumoDif">R$ 0,00</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div class="tab-pane fade" id="tabCats">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-primary">
                <tr><th style="width:70px">#</th><th>Categoria</th></tr>
              </thead>
              <tbody id="tbodyCats"></tbody>
            </table>
          </div>
        </div>

        <div class="tab-pane fade" id="tabPivot">
          <div class="table-responsive">
            <table class="table table-bordered table-hover" id="tabelaPivot">
              <thead class="table-info">
                <tr>
                  <th>Categoria</th>
                  <th>Total Entradas</th>
                  <th>Total Sa√≠das</th>
                  <th>Diferen√ßa</th>
                </tr>
              </thead>
              <tbody id="tbodyPivot"></tbody>
              <tfoot>
                <tr>
                  <th class="text-end">Totais:</th>
                  <th class="text-end text-success" id="ftPivotEntrada">R$ 0,00</th>
                  <th class="text-end text-danger" id="ftPivotSaida">R$ 0,00</th>
                  <th class="text-end fw-bold" id="ftPivotDif">R$ 0,00</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div class="tab-pane fade" id="tabGraficos">
          <div class="row g-3">
            <div class="col-lg-6">
              <div class="chart-wrap"><canvas id="chartSaldo"></canvas></div>
            </div>
            <div class="col-lg-6">
              <div class="chart-wrap"><canvas id="chartCategorias"></canvas></div>
            </div>
            <div class="col-12">
              <div class="chart-wrap"><canvas id="chartComparativo"></canvas></div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="tabAno">
          <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
            <button class="btn btn-outline-primary" id="btnCarregarAno"><i class="bi bi-search"></i> Carregar Ano</button>
            <button class="btn btn-outline-success" id="btnExportarAno"><i class="bi bi-download"></i> Exportar Ano XLSX</button>
            <button class="btn btn-outline-secondary" id="btnCarregarTodos"><i class="bi bi-collection"></i> Carregar Todos</button>
            <button class="btn btn-outline-warning" id="btnExportarTodos"><i class="bi bi-cloud-download"></i> Exportar Todos XLSX</button>
            <button class="btn btn-outline-dark" id="btnVoltarMes"><i class="bi bi-arrow-left-circle"></i> Voltar para M√™s</button>
            <div class="vr" style="height:30px"></div>
            <span class="small fw-bold text-muted">Visualizar:</span>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="toggleAno" checked>
              <label class="form-check-label small" for="toggleAno">Dados do Ano</label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="toggleTodos" checked>
              <label class="form-check-label small" for="toggleTodos">Todos os Anos</label>
            </div>
            <span id="anoInfo" class="small text-muted ms-auto"></span>
          </div>
          <div class="row g-3" id="secaoAno" style="display:none">
            <div class="col-12">
              <h6 class="text-muted mb-3"><i class="bi bi-calendar-check"></i> Resumo Anual por Categoria</h6>
            </div>
            <div class="col-lg-6">
              <div class="table-responsive">
                <table class="table table-bordered table-sm" id="tblAnoCat">
                  <thead class="table-dark">
                    <tr><th>Categoria</th><th>Entradas</th><th>Sa√≠das</th><th>Diferen√ßa</th></tr>
                  </thead>
                  <tbody></tbody>
                  <tfoot></tfoot>
                </table>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="chart-wrap"><canvas id="chartAnoMeses"></canvas></div>
            </div>
          </div>
          <div class="row g-3 mt-1" id="secaoTodos" style="display:none">
            <div class="col-12">
              <h6 class="text-muted mb-3"><i class="bi bi-calendar2-range"></i> Comparativo de Todos os Anos</h6>
            </div>
            <div class="col-12">
              <div class="table-responsive">
                <table class="table table-striped table-sm" id="tblTodosAnos">
                  <thead class="table-info"><tr><th>Ano</th><th>Entradas</th><th>Sa√≠das</th><th>Diferen√ßa</th></tr></thead>
                  <tbody></tbody>
                  <tfoot></tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.14.1/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script>
    /**
     * ============================================================================
     * GESTOR FINANCEIRO PESSOAL v1.0.0
     * ============================================================================
     * Desenvolvedor: Ot√°vio Silva
     * Email: otavio.silva1661@gmail.com
     * GitHub: https://github.com/Otavio1661
     * 
     * Copyright (c) 2026 Ot√°vio Silva
     * Licenciado sob MIT License
     * ============================================================================
     */
    
    let currentMonth = new Date().getMonth() + 1;
    let currentYear = new Date().getFullYear();
    let transactions = [];
  let dtLanc = null, chSaldo=null, chCats=null, chComp=null, chAnoMeses=null;
    // Escopo de visualiza√ß√£o
    let scopeMode = 'month'; // 'month' | 'year' | 'all'
    let scopeTrans = [];
    const getTrans = () => scopeMode==='month' ? transactions : scopeTrans;
    function setScope(mode, arr){ scopeMode = mode; scopeTrans = Array.isArray(arr) ? arr : []; updateScopeUI(); }
    function updateScopeUI(){
      const $badge=$('#scopeStatus');
      if(scopeMode==='month'){ $badge.text('M√™s').removeClass('text-bg-secondary').addClass('text-bg-info'); $('#btnAtualizar').prop('disabled', false); }
      if(scopeMode==='year'){ $badge.text('Ano').removeClass('text-bg-info').addClass('text-bg-secondary'); $('#btnAtualizar').prop('disabled', true); }
      if(scopeMode==='all'){ $badge.text('Todos').removeClass('text-bg-info').addClass('text-bg-secondary'); $('#btnAtualizar').prop('disabled', true); }
    }
    const CATEGORIAS = ["Sal√°rio","Receita Extra","Moradia","Alimenta√ß√£o","Transporte","Sa√∫de","Lazer","Educa√ß√£o","Cart√£o de Cr√©dito","Cart√£o de D√©bito","Outros"];
    const fmtMoney = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);
    const fmtDate = s => {const d=new Date(s+'T00:00:00'); return d.toLocaleDateString('pt-BR');}
  const keyFile = () => `${String(currentMonth).padStart(2,'0')}-${currentYear}.xlsx`;
  let salvarDirHandle = null; // File System Access API directory handle

  $(function(){ initSelectors(); setToday(); bindEvents(); initFs().then(()=>loadTransactions()).then(()=>{ initCharts(); renderAll(); }); });
    function initSelectors(){ $('#monthSelect').val(String(currentMonth).padStart(2,'0')); const $y=$('#yearSelect'); for(let y=2020;y<=2035;y++) $y.append(`<option ${y===currentYear?'selected':''}>${y}</option>`); }
    function setToday(){ 
      // Define a data para o primeiro dia do m√™s/ano selecionado
      const mesAtual = String(currentMonth).padStart(2,'0');
      const anoAtual = currentYear;
      $('#data').val(`${anoAtual}-${mesAtual}-01`);
      // Define limites min/max no campo de data
      const ultimoDia = new Date(anoAtual, currentMonth, 0).getDate();
      $('#data').attr('min', `${anoAtual}-${mesAtual}-01`);
      $('#data').attr('max', `${anoAtual}-${mesAtual}-${String(ultimoDia).padStart(2,'0')}`);
    }
  function bindEvents(){ $('#formLancamento').on('submit', onAdd); $('#monthSelect,#yearSelect').on('change', ()=>{currentMonth=parseInt($('#monthSelect').val()); currentYear=parseInt($('#yearSelect').val()); setScope('month'); setToday(); loadTransactions().then(()=>{ renderAll(); });}); $('#btnAtualizar').on('click', ()=>{ saveTransactions().then(()=>loadTransactions()).then(()=>{ renderAll(); Swal.fire({icon:'success',title:'Salvo/Atualizado!',timer:1000,showConfirmButton:false}); }); }); $('#entrada').on('input', ()=>{ if($('#entrada').val()) $('#saida').val(''); }); $('#saida').on('input', ()=>{ if($('#saida').val()) $('#entrada').val(''); }); $('#btnExportar').on('click', exportXLSX); $('#btnExportarCategoria').on('click', exportarPorCategoria); $('#inputImportar').on('change', importXLSX); $('#btnFolder').on('click', selectSalvarFolder); $('#btnCarregarAno').on('click', ()=>{ carregarAno(currentYear); $('#toggleAno').prop('checked', true); updateAnoVisibility(); }); $('#btnExportarAno').on('click', ()=>{ exportarAnoXLSX(currentYear); }); $('#btnCarregarTodos').on('click', ()=>{ carregarTodosAnos(); $('#toggleTodos').prop('checked', true); updateAnoVisibility(); }); $('#btnExportarTodos').on('click', exportarTodosAnosXLSX); $('#btnVoltarMes').on('click', ()=>{ setScope('month'); loadTransactions().then(()=>{ renderAll(); Swal.fire({icon:'info',title:'Voltou para M√™s',timer:800,showConfirmButton:false}); }); }); $('#toggleAno').on('change', updateAnoVisibility); $('#toggleTodos').on('change', updateAnoVisibility); }

    // ===== File System Access API helpers (Chrome/Edge/Opera) =====
    async function idbOpen(){
      return await new Promise((resolve, reject)=>{
        const req = indexedDB.open('finance-fs', 1);
        req.onupgradeneeded = () => { req.result.createObjectStore('handles'); };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    async function idbGet(key){ const db=await idbOpen(); return await new Promise((res,rej)=>{ const tx=db.transaction('handles','readonly'); const st=tx.objectStore('handles'); const g=st.get(key); g.onsuccess=()=>res(g.result||null); g.onerror=()=>rej(g.error); }); }
    async function idbSet(key,val){ const db=await idbOpen(); return await new Promise((res,rej)=>{ const tx=db.transaction('handles','readwrite'); const st=tx.objectStore('handles'); const p=st.put(val,key); p.onsuccess=()=>res(true); p.onerror=()=>rej(p.error); }); }
    async function ensurePerm(handle){ if(!handle) return false; const q = await handle.queryPermission({mode:'readwrite'}); if(q==='granted') return true; const r = await handle.requestPermission({mode:'readwrite'}); return r==='granted'; }
    async function initFs(){
      try{
        if(!('showDirectoryPicker' in window)){ updateFolderStatus('Sem suporte ao acesso ao sistema de arquivos'); return; }
        salvarDirHandle = await idbGet('salvarDir');
        if(salvarDirHandle){
          const ok = await ensurePerm(salvarDirHandle);
          if(!ok){ updateFolderStatus('Permiss√£o pendente'); }
          else { updateFolderStatus('Pasta pronta'); }
        } else { updateFolderStatus('Selecione a pasta salvar'); }
      }catch{ updateFolderStatus('Selecione a pasta salvar'); }
    }
    function updateFolderStatus(msg){ $('#folderStatus').text(msg||''); }
    async function selectSalvarFolder(){
      try{
        const dir = await window.showDirectoryPicker({ startIn: 'documents' });
        // opcional: validar que a pasta selecionada √© "salvar"
        salvarDirHandle = dir; await idbSet('salvarDir', dir); updateFolderStatus('Pasta pronta');
        await loadTransactions(); renderAll();
      }catch(e){ console.warn('Sele√ß√£o de pasta cancelada/erro', e); }
    }
    // ===== XLSX helpers =====
    function buildSheetData(){
      // Header row + data rows
      const header = ['id','data','descricao','categoria','entrada','saida'];
      const rows = transactions.map(t=>[
        t.id,
        t.data,
        t.descricao,
        t.categoria,
        Number(t.entrada||0),
        Number(t.saida||0)
      ]);
      return [header, ...rows];
    }
    function sheetToTransactions(sheet){
      const rows = XLSX.utils.sheet_to_json(sheet, { header:1, defval:'' });
      if(!rows || rows.length===0) return [];
      // Expect header in first row
      const header = rows[0].map(h=>String(h).toLowerCase());
      const idx = key=> header.indexOf(key);
      const iId=idx('id'), iData=idx('data'), iDesc=idx('descricao'), iCat=idx('categoria'), iE=idx('entrada'), iS=idx('saida');
      const out=[];
      for(let r=1;r<rows.length;r++){
        const row = rows[r];
        if(!row || (row.every(v=>String(v).trim()===''))) continue;
        const id = Number(row[iId]||Date.now()+r);
        const data = String(row[iData]||'').slice(0,10);
        const descricao = String(row[iDesc]||'');
        const categoria = String(row[iCat]||'');
        const entrada = Number(row[iE]||0);
        const saida = Number(row[iS]||0);
        out.push({id,data: data || new Date().toISOString().split('T')[0], descricao, categoria, entrada, saida, saldo:0});
      }
      return out;
    }
    async function fileReadXlsx(fileHandle){
      const f = await fileHandle.getFile();
      if(!f || f.size===0) return [];
      const buf = await f.arrayBuffer();
      try{
        const wb = XLSX.read(buf, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        return sheetToTransactions(ws);
      }catch(e){ console.warn('Falha ao ler XLSX', e); return []; }
    }
    async function fileWriteXlsx(fileHandle){
      const aoa = buildSheetData();
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, `${String(currentMonth).padStart(2,'0')}-${currentYear}`);
      const buf = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const w = await fileHandle.createWritable();
      await w.write(buf);
      await w.close();
    }
    async function saveTransactions(){
      if(salvarDirHandle && await ensurePerm(salvarDirHandle)){
        const fh = await salvarDirHandle.getFileHandle(keyFile(), {create:true});
        await fileWriteXlsx(fh);
      } else {
        // fallback localStorage (JSON interno) enquanto a pasta n√£o for escolhida
        localStorage.setItem(`${String(currentMonth).padStart(2,'0')}-${currentYear}.json`, JSON.stringify({mes:currentMonth,ano:currentYear,transacoes:transactions}, null, 2));
      }
    }
    async function loadTransactions(){
      if(salvarDirHandle && await ensurePerm(salvarDirHandle)){
        try{
          const fh = await salvarDirHandle.getFileHandle(keyFile(), {create:true});
          const arr = await fileReadXlsx(fh);
          transactions = Array.isArray(arr) ? arr : [];
          if(arr.length===0){
            // arquivo rec√©m-criado, grava cabe√ßalho vazio
            await fileWriteXlsx(fh);
          }
          return;
        }catch(e){ console.warn('Falha ao ler arquivo do m√™s', e); transactions = []; return; }
      }
      // fallback local
      const raw=localStorage.getItem(`${String(currentMonth).padStart(2,'0')}-${currentYear}.json`);
      if(raw){ try{ transactions = JSON.parse(raw).transacoes||[]; }catch{ transactions=[]; } } else { transactions=[]; }
    }
  async function onAdd(e){ 
    e.preventDefault(); 
    if(scopeMode!=='month'){ return Swal.fire({icon:'info',title:'Adi√ß√£o apenas na vis√£o Mensal'}); } 
    const entrada=parseFloat($('#entrada').val()||'0'); 
    const saida=parseFloat($('#saida').val()||'0'); 
    if(entrada<=0 && saida<=0){ return Swal.fire({icon:'warning',title:'Informe Entrada ou Sa√≠da'}); } 
    const dataLanc = $('#data').val(); 
    const [ano, mes] = dataLanc.split('-').map(n=>parseInt(n)); 
    if(mes !== currentMonth || ano !== currentYear){ return Swal.fire({icon:'error',title:'Data inv√°lida!',text:`A data deve estar em ${String(currentMonth).padStart(2,'0')}/${currentYear}`}); } 
    
    const descricao = $('#descricao').val();
    const categoria = $('#categoria').val();
    
    // Se for Cart√£o de Cr√©dito, perguntar sobre parcelamento
    if(categoria === 'Cart√£o de Cr√©dito' && saida > 0){
      const { value: parcelas } = await Swal.fire({
        title: 'Parcelamento do Cart√£o',
        html: `
          <div style="text-align: left; margin-bottom: 15px;">
            <strong>Valor total:</strong> ${fmtMoney(saida)}
          </div>
          <label for="swal-parcelas" class="form-label">Quantas parcelas?</label>
          <select id="swal-parcelas" class="form-select">
            <option value="nesse-mes">Nesse m√™s (√† vista)</option>
            <option value="1">1x de ${fmtMoney(saida)}</option>
            ${Array.from({length: 23}, (_, i) => {
              const n = i + 2;
              const valorParcela = saida / n;
              return `<option value="${n}">${n}x de ${fmtMoney(valorParcela)}</option>`;
            }).join('')}
          </select>
        `,
        showCancelButton: true,
        confirmButtonText: 'Adicionar',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
          return document.getElementById('swal-parcelas').value;
        }
      });
      
      if(!parcelas) return; // Cancelado
      
      if(parcelas === 'nesse-mes' || parcelas === '1'){
        // Adicionar normalmente no m√™s atual
        const t={id:Date.now(),data:dataLanc,descricao,categoria,entrada,saida,saldo:0};
        transactions.push(t);
        await saveTransactions();
        await loadTransactions();
        $('#formLancamento')[0].reset(); 
        setToday(); 
        renderAll(); 
        Swal.fire({icon:'success',title:'Lan√ßamento adicionado!',timer:900,showConfirmButton:false});
      } else {
        // Parcelamento em m√∫ltiplos meses
        const numParcelas = parseInt(parcelas);
        const valorParcela = saida / numParcelas;
        
        // Adicionar parcelas em cada m√™s
        for(let i = 0; i < numParcelas; i++){
          let mesParc = mes + i;
          let anoParc = ano;
          
          // Ajustar ano se passar de dezembro
          while(mesParc > 12){
            mesParc -= 12;
            anoParc += 1;
          }
          
          // Definir o dia da parcela (primeiro dia do m√™s)
          const dataParc = `${anoParc}-${String(mesParc).padStart(2,'0')}-01`;
          
          // Criar descri√ß√£o com n√∫mero da parcela
          const descParc = `${descricao} (${i+1}/${numParcelas})`;
          
          // Criar a transa√ß√£o
          const t = {
            id: Date.now() + i,
            data: dataParc,
            descricao: descParc,
            categoria,
            entrada: 0,
            saida: valorParcela,
            saldo: 0
          };
          
          // Salvar em cada arquivo de m√™s correspondente
          const mesOriginal = currentMonth;
          const anoOriginal = currentYear;
          
          currentMonth = mesParc;
          currentYear = anoParc;
          
          await loadTransactions();
          transactions.push(t);
          await saveTransactions();
          
          // Restaurar m√™s/ano original
          currentMonth = mesOriginal;
          currentYear = anoOriginal;
        }
        
        // Recarregar o m√™s atual
        await loadTransactions();
        $('#formLancamento')[0].reset(); 
        setToday(); 
        renderAll(); 
        Swal.fire({
          icon:'success',
          title:'Parcelamento adicionado!',
          text:`${numParcelas} parcelas de ${fmtMoney(valorParcela)} adicionadas`,
          timer:2000,
          showConfirmButton:false
        });
      }
    } else {
      // Categoria normal (n√£o √© Cart√£o de Cr√©dito)
      const t={id:Date.now(),data:dataLanc,descricao,categoria,entrada,saida,saldo:0}; 
      transactions.push(t); 
      await saveTransactions();
      await loadTransactions();
      $('#formLancamento')[0].reset(); 
      setToday(); 
      renderAll(); 
      Swal.fire({icon:'success',title:'Lan√ßamento adicionado!',timer:900,showConfirmButton:false});
    }
  }
  function onDelete(id){ if(scopeMode!=='month'){ return Swal.fire({icon:'info',title:'Exclus√£o apenas na vis√£o Mensal'}); } Swal.fire({title:'Excluir lan√ßamento?',icon:'warning',showCancelButton:true,confirmButtonText:'Excluir',confirmButtonColor:'#c00000'}).then(r=>{ if(r.isConfirmed){ transactions = transactions.filter(x=>x.id!==id); saveTransactions().then(()=>loadTransactions()).then(()=>renderAll()); } }); }
  function renderAll(){ renderLancamentos(); renderResumo(); renderCategorias(); renderPivot(); updateSummary(); updateCharts(); }
    function renderLancamentos(){
      const arr=[...getTrans()].sort((a,b)=> new Date(a.data)-new Date(b.data));
      let saldo=0; arr.forEach(t=>{ saldo += (t.entrada - t.saida); t.saldo = saldo; });
      if(dtLanc){ dtLanc.destroy(); }
      const $tb=$('#tbodyLanc').empty();
      arr.forEach(t=>{ const sClass=t.saldo<0?'saldo-neg':'saldo-pos'; const actions = scopeMode==='month' ? `<button class="btn btn-sm btn-danger" onclick="onDelete(${t.id})"><i class="bi bi-trash"></i></button>` : `<span class='text-muted'>-</span>`; $tb.append(`<tr><td>${fmtDate(t.data)}</td><td><strong>${t.descricao}</strong></td><td><span class="categoria-badge">${t.categoria}</span></td><td class="text-end ${t.entrada>0?'cell-entrada':''}">${t.entrada>0?fmtMoney(t.entrada):'-'}</td><td class="text-end ${t.saida>0?'cell-saida':''}">${t.saida>0?fmtMoney(t.saida):'-'}</td><td class="text-end ${sClass}">${fmtMoney(t.saldo)}</td><td class="text-center">${actions}</td></tr>`); });
      // Totais
      const totE = arr.reduce((a,t)=>a+t.entrada,0);
      const totS = arr.reduce((a,t)=>a+t.saida,0);
      const totSaldo = arr.length?arr[arr.length-1].saldo:0;
      $('#tabelaLancamentos tfoot').html(`<tr>
        <th colspan="3" class="text-end">Totais:</th>
        <th class="text-end text-success">${fmtMoney(totE)}</th>
        <th class="text-end text-danger">${fmtMoney(totS)}</th>
        <th class="text-end fw-bold">${fmtMoney(totSaldo)}</th>
        <th></th>
      </tr>`);
      dtLanc=$('#tabelaLancamentos').DataTable({ language:{url:'//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'}, responsive:true, order:[[0,'asc']], pageLength:15, columnDefs:[{targets:6, orderable:false}] });
    }
    function renderResumo(){
      const byCat=CATEGORIAS.reduce((acc,c)=>{acc[c]={e:0,s:0};return acc;},{});
      getTrans().forEach(t=>{ if(byCat[t.categoria]){ byCat[t.categoria].e+=t.entrada; byCat[t.categoria].s+=t.saida; }});
      const $b=$('#tbodyResumo').empty();
      let totE=0, totS=0;
      Object.keys(byCat).forEach(c=>{ const e=byCat[c].e, s=byCat[c].s, d=e-s; totE+=e; totS+=s; const cls=d>=0?'text-success':'text-danger'; $b.append(`<tr><td><strong>${c}</strong></td><td class="text-end text-success">${fmtMoney(e)}</td><td class="text-end text-danger">${fmtMoney(s)}</td><td class="text-end ${cls} fw-bold">${fmtMoney(e-s)}</td></tr>`); });
      const dif = totE - totS;
      $('#tabelaResumo tfoot').html(`<tr>
        <th class="text-end">Totais:</th>
        <th class="text-end text-success">${fmtMoney(totE)}</th>
        <th class="text-end text-danger">${fmtMoney(totS)}</th>
        <th class="text-end fw-bold">${fmtMoney(dif)}</th>
      </tr>`);
    }
  function renderCategorias(){ const $b=$('#tbodyCats').empty(); CATEGORIAS.forEach((c,i)=>{ $b.append(`<tr><td class="text-center">${i+1}</td><td><strong>${c}</strong></td></tr>`); }); }
  function renderPivot(){
    const pivot=CATEGORIAS.reduce((acc,c)=>{acc[c]={e:0,s:0};return acc;},{});
    getTrans().forEach(t=>{ if(pivot[t.categoria]){ pivot[t.categoria].e+=t.entrada; pivot[t.categoria].s+=t.saida; } });
    const $b=$('#tbodyPivot').empty();
    let totE=0, totS=0;
    Object.keys(pivot).forEach(c=>{ const e=pivot[c].e, s=pivot[c].s, d=e-s; totE+=e; totS+=s; const cls=d>=0?'text-success':'text-danger'; $b.append(`<tr><td><strong>${c}</strong></td><td class="text-end text-success">${fmtMoney(e)}</td><td class="text-end text-danger">${fmtMoney(s)}</td><td class="text-end ${cls} fw-bold">${fmtMoney(d)}</td></tr>`); });
    $('#tabelaPivot tfoot').html(`<tr>
      <th class="text-end">Totais:</th>
      <th class="text-end text-success">${fmtMoney(totE)}</th>
      <th class="text-end text-danger">${fmtMoney(totS)}</th>
      <th class="text-end fw-bold">${fmtMoney(totE-totS)}</th>
    </tr>`);
  }
  function updateSummary(){ const list=getTrans(); const e=list.reduce((a,t)=>a+t.entrada,0); const s=list.reduce((a,t)=>a+t.saida,0); const d=e-s; $('#totalEntradas').text(fmtMoney(e)); $('#totalSaidas').text(fmtMoney(s)); $('#saldoFinal').text(fmtMoney(d)).toggleClass('saldo-neg', d<0).toggleClass('saldo-pos', d>=0); }
    function initCharts(){ chSaldo=new Chart(document.getElementById('chartSaldo').getContext('2d'),{ type:'line', data:{labels:[],datasets:[{label:'Saldo acumulado',data:[],borderColor:'#0dcaf0',backgroundColor:'rgba(13,202,240,.12)',fill:true,tension:.35}]}, options:{maintainAspectRatio:false,responsive:true} }); chCats=new Chart(document.getElementById('chartCategorias').getContext('2d'),{ type:'doughnut', data:{labels:[],datasets:[{data:[],backgroundColor:['#ff6384','#36a2eb','#ffce56','#4bc0c0','#9966ff','#ff9f40','#c9cbcf','#00c49f','#845ec2']} ]}, options:{maintainAspectRatio:false,responsive:true} }); chComp=new Chart(document.getElementById('chartComparativo').getContext('2d'),{ type:'bar', data:{labels:[],datasets:[{label:'Entradas',data:[],backgroundColor:'#00a86b'},{label:'Sa√≠das',data:[],backgroundColor:'#dc3545'}]}, options:{maintainAspectRatio:false,responsive:true} }); }
    function initCharts(){
      chSaldo=new Chart(document.getElementById('chartSaldo').getContext('2d'),{ type:'line', data:{labels:[],datasets:[{label:'Saldo acumulado',data:[],borderColor:'#0dcaf0',backgroundColor:'rgba(13,202,240,.12)',fill:true,tension:.35}]}, options:{maintainAspectRatio:false,responsive:true} });
      chCats=new Chart(document.getElementById('chartCategorias').getContext('2d'),{ type:'doughnut', data:{labels:[],datasets:[{data:[],backgroundColor:['#ff6384','#36a2eb','#ffce56','#4bc0c0','#9966ff','#ff9f40','#c9cbcf','#00c49f','#845ec2']} ]}, options:{maintainAspectRatio:false,responsive:true} });
      chComp=new Chart(document.getElementById('chartComparativo').getContext('2d'),{ type:'bar', data:{labels:[],datasets:[{label:'Entradas',data:[],backgroundColor:'#00a86b'},{label:'Sa√≠das',data:[],backgroundColor:'#dc3545'}]}, options:{maintainAspectRatio:false,responsive:true} });
      const anoCtx=document.getElementById('chartAnoMeses');
      if(anoCtx){ chAnoMeses=new Chart(anoCtx.getContext('2d'),{ type:'bar', data:{labels:[],datasets:[{label:'Entradas Ano',data:[],backgroundColor:'#198754'},{label:'Sa√≠das Ano',data:[],backgroundColor:'#dc3545'}]}, options:{maintainAspectRatio:false,responsive:true} }); }
    }
  function updateCharts(){ const arr=[...getTrans()].sort((a,b)=> new Date(a.data)-new Date(b.data)); let s=0; const labels=[], data=[]; arr.forEach(t=>{ s+=t.entrada-t.saida; labels.push(fmtDate(t.data)); data.push(s); }); chSaldo.data.labels=labels; chSaldo.data.datasets[0].data=data; chSaldo.update(); const cat=CATEGORIAS.reduce((acc,c)=>{acc[c]=0;return acc;},{}); getTrans().forEach(t=>{ if(cat[t.categoria]!=null) cat[t.categoria]+=t.saida; }); const l=[], d=[]; Object.keys(cat).forEach(c=>{ if(cat[c]>0){ l.push(c); d.push(cat[c]); } }); chCats.data.labels=l; chCats.data.datasets[0].data=d; chCats.update(); const eBy={}, sBy={}; CATEGORIAS.forEach(c=>{eBy[c]=0; sBy[c]=0;}); getTrans().forEach(t=>{ if(eBy[t.categoria]!=null){ eBy[t.categoria]+=t.entrada; sBy[t.categoria]+=t.saida; } }); chComp.data.labels=CATEGORIAS; chComp.data.datasets[0].data=Object.values(eBy); chComp.data.datasets[1].data=Object.values(sBy); chComp.update(); }
  async function exportXLSX(){
    // Exportar TODO O ANO em uma √∫nica tabela consolidada
    if(!salvarDirHandle){ 
      return Swal.fire({icon:'info',title:'Selecione a pasta salvar primeiro',text:'Clique no bot√£o "salvar" para escolher a pasta'}); 
    }

    const dataH = new Date();
    const dataHoje = `${String(dataH.getDate()).padStart(2,'0')}_${String(dataH.getMonth()+1).padStart(2,'0')}_${dataH.getFullYear()}`;
    const fmtBRData = (iso) => {
      if(!iso) return '';
      const part = String(iso).slice(0,10);
      const [y,m,d] = part.split('-').map(n=>parseInt(n,10));
      if(!y||!m||!d) return part;
      const dt = new Date(y, m-1, d);
      return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`;
    };

    // Carrega TODOS os 12 meses do ano atual
    Swal.fire({title:'Carregando dados do ano...', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});
    const todosLancamentos = [];
    for(let m=1; m<=12; m++){
      const fname = `${String(m).padStart(2,'0')}-${currentYear}.xlsx`;
      try{
        const fh = await salvarDirHandle.getFileHandle(fname, {create:false});
        const arr = await fileReadXlsx(fh);
        todosLancamentos.push(...arr);
      }catch{ /* m√™s sem dados */ }
    }
    Swal.close();

    if(!todosLancamentos.length){ 
      return Swal.fire({icon:'info',title:'Nenhum dado encontrado',text:`N√£o h√° lan√ßamentos em ${currentYear}`}); 
    }

    // Ordena todos por data
    const dados = todosLancamentos.sort((a,b)=> new Date(a.data)-new Date(b.data));

    // Recalcula saldo acumulado para export
    let saldo=0;
    const linhasLanc = dados.map(t=>{ saldo += (Number(t.entrada||0) - Number(t.saida||0)); return [fmtBRData(t.data), t.descricao, t.categoria, Number(t.entrada||0), Number(t.saida||0), saldo]; });

    const fileName = `ANO-COMPLETO-${currentYear}_${dataHoje}.xlsx`;

    const HEADER_STYLE = (cell)=>{
      cell.font = { bold:true, color:{argb:'FFFFFFFF'}, size:12 };
      cell.fill = { type:'pattern', pattern:'solid', fgColor:{argb:'FF2C5F8D'} };
      cell.alignment = { vertical:'middle', horizontal:'center' };
      cell.border = { top:{style:'thin',color:{argb:'FF000000'}}, bottom:{style:'thin',color:{argb:'FF000000'}}, left:{style:'thin',color:{argb:'FF000000'}}, right:{style:'thin',color:{argb:'FF000000'}} };
    };

    const TOTAL_STYLE = (cell)=>{
      cell.font = { bold:true, size:11 };
      cell.fill = { type:'pattern', pattern:'solid', fgColor:{argb:'FFE7E6E6'} };
      cell.border = { top:{style:'medium',color:{argb:'FF000000'}}, bottom:{style:'thin',color:{argb:'FF000000'}}, left:{style:'thin',color:{argb:'FF000000'}}, right:{style:'thin',color:{argb:'FF000000'}} };
    };

    const CELL_BORDER = {
      top:{style:'thin',color:{argb:'FFD3D3D3'}},
      bottom:{style:'thin',color:{argb:'FFD3D3D3'}},
      left:{style:'thin',color:{argb:'FFD3D3D3'}},
      right:{style:'thin',color:{argb:'FFD3D3D3'}}
    };

    try{
      if(typeof ExcelJS==='undefined' || !ExcelJS.Workbook) throw new Error('ExcelJS n√£o carregada');
      const wb = new ExcelJS.Workbook();
      wb.creator = 'Controle Financeiro'; wb.created = new Date();
      wb.company = 'Gestor Financeiro';

      // UMA √öNICA ABA com TODOS os lan√ßamentos do ano
      const wsLanc = wb.addWorksheet(`Ano ${currentYear} - Completo`);
      wsLanc.columns = [
        {header:'Data', key:'data', width:14},
        {header:'Descri√ß√£o', key:'desc', width:45},
        {header:'Categoria', key:'cat', width:22},
        {header:'Entrada (+)', key:'ent', width:18},
        {header:'Sa√≠da (-)', key:'sai', width:18},
        {header:'Saldo Acumulado', key:'saldo', width:20}
      ];
      linhasLanc.forEach(r=> wsLanc.addRow(r));
      wsLanc.getRow(1).eachCell(HEADER_STYLE);
      wsLanc.getRow(1).height = 24;
      // Formata√ß√£o de valores
      wsLanc.getColumn(4).numFmt = '"R$ "#,##0.00';
      wsLanc.getColumn(5).numFmt = '"R$ "#,##0.00';
      wsLanc.getColumn(6).numFmt = '"R$ "#,##0.00';
      wsLanc.getColumn(4).alignment = {horizontal:'right', vertical:'middle'};
      wsLanc.getColumn(5).alignment = {horizontal:'right', vertical:'middle'};
      wsLanc.getColumn(6).alignment = {horizontal:'right', vertical:'middle'};
      wsLanc.getColumn(1).alignment = {horizontal:'center', vertical:'middle'};
      wsLanc.getColumn(2).alignment = {horizontal:'left', vertical:'middle'};
      wsLanc.getColumn(3).alignment = {horizontal:'center', vertical:'middle'};
      // Bordas em todas as c√©lulas
      wsLanc.eachRow((row, rowNumber) => { if(rowNumber > 1) row.eachCell(cell => cell.border = CELL_BORDER); });
      // Linha de totais
      const totE = linhasLanc.reduce((a,r)=>a+r[3],0);
      const totS = linhasLanc.reduce((a,r)=>a+r[4],0);
      const totSaldo = linhasLanc.length ? linhasLanc[linhasLanc.length-1][5] : 0;
      const totalRow = wsLanc.addRow(['','','TOTAIS', totE, totS, totSaldo]);
      totalRow.eachCell((cell, colNumber) => {
        TOTAL_STYLE(cell);
        if(colNumber >= 3) cell.alignment = {horizontal: colNumber===3?'center':'right', vertical:'middle'};
      });
      totalRow.height = 22;

      const buf = await wb.xlsx.writeBuffer();
      const blob = new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); URL.revokeObjectURL(a.href);
      Swal.fire({icon:'success',title:`Ano ${currentYear} exportado!`,text:`${linhasLanc.length} lan√ßamentos em uma √∫nica tabela`,timer:2000,showConfirmButton:false});
    }catch(err){
      console.warn('ExcelJS falhou, usando fallback simples SheetJS', err);
      // Fallback: exporta apenas Lan√ßamentos simples
      const aoa = [['Data','Descri√ß√£o','Categoria','Entrada (+)','Sa√≠da (-)','Saldo Acumulado'], ...linhasLanc];
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, `Ano ${currentYear}`);
      const wbout = XLSX.write(wb,{bookType:'xlsx',type:'array'});
      const blob = new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); URL.revokeObjectURL(a.href);
      Swal.fire({icon:'success',title:`Ano ${currentYear} exportado!`,timer:1500,showConfirmButton:false});
    }
  }
  function importXLSX(e){
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{ try{
      const data=new Uint8Array(reader.result);
      const wb=XLSX.read(data,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const arr = sheetToTransactions(ws);
      transactions = arr;
      saveTransactions().then(()=>loadTransactions()).then(()=>{ renderAll(); Swal.fire({icon:'success',title:'Importado!'}); });
    } catch{ Swal.fire({icon:'error',title:'Arquivo inv√°lido'}); } };
    reader.readAsArrayBuffer(file);
    e.target.value='';
  }
  // ====== CONTROLE DE VISIBILIDADE ANO/GERAL ======
  function updateAnoVisibility(){
    const showAno = $('#toggleAno').is(':checked');
    const showTodos = $('#toggleTodos').is(':checked');
    $('#secaoAno').toggle(showAno);
    $('#secaoTodos').toggle(showTodos);
  }
  
  // ====== ANO / GERAL AGGREGATIONS ======
  async function carregarAno(ano){
    if(!salvarDirHandle){ return Swal.fire({icon:'info',title:'Selecione a pasta salvar'}); }
    const mesesData=[]; // array de arrays de transa√ß√µes por m√™s
    for(let m=1;m<=12;m++){
      const fname=`${String(m).padStart(2,'0')}-${ano}.xlsx`;
      try{ const fh=await salvarDirHandle.getFileHandle(fname,{create:false}); const arr=await fileReadXlsx(fh); mesesData.push({mes:m, trans:arr}); }catch{ mesesData.push({mes:m, trans:[]}); }
    }
    // Atualiza escopo para Ano e reflete nas tabelas principais
    const all = mesesData.flatMap(md=> md.trans.map(t=>({...t})));
    setScope('year', all);
    renderAll();
    // Categoria resumo anual
    const catMap=CATEGORIAS.reduce((a,c)=>{a[c]={e:0,s:0}; return a;},{});
    mesesData.forEach(md=> md.trans.forEach(t=>{ if(catMap[t.categoria]){ catMap[t.categoria].e+=t.entrada; catMap[t.categoria].s+=t.saida; }}));
    const $tbody=$('#tblAnoCat tbody').empty(); let totE=0, totS=0;
    Object.keys(catMap).forEach(c=>{ const e=catMap[c].e; const s=catMap[c].s; totE+=e; totS+=s; const d=e-s; const cls=d>=0?'text-success':'text-danger'; $tbody.append(`<tr><td><strong>${c}</strong></td><td class='text-end text-success'>${fmtMoney(e)}</td><td class='text-end text-danger'>${fmtMoney(s)}</td><td class='text-end ${cls} fw-bold'>${fmtMoney(d)}</td></tr>`); });
    $('#tblAnoCat tfoot').html(`<tr><th class='text-end'>Totais:</th><th class='text-end text-success'>${fmtMoney(totE)}</th><th class='text-end text-danger'>${fmtMoney(totS)}</th><th class='text-end fw-bold'>${fmtMoney(totE-totS)}</th></tr>`);
    // Mensal chart
    if(chAnoMeses){
      const labels=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
      const entradas=mesesData.map(md=> md.trans.reduce((a,t)=>a+t.entrada,0));
      const saidas=mesesData.map(md=> md.trans.reduce((a,t)=>a+t.saida,0));
      chAnoMeses.data.labels=labels; chAnoMeses.data.datasets[0].data=entradas; chAnoMeses.data.datasets[1].data=saidas; chAnoMeses.update();
    }
    $('#anoInfo').text(`Ano ${ano}: ${fmtMoney(totE)} entradas / ${fmtMoney(totS)} sa√≠das`);
    $('#secaoAno').show();
  }
  async function listarArquivosMes(){
    if(!salvarDirHandle) return [];
    const out=[];
    for await (const entry of salvarDirHandle.values()){
      if(entry.kind==='file' && /\d{2}-\d{4}\.xlsx$/.test(entry.name)) out.push(entry.name);
    }
    return out;
  }
  async function carregarTodosAnos(){
    if(!salvarDirHandle){ return Swal.fire({icon:'info',title:'Selecione a pasta salvar'}); }
    const files=await listarArquivosMes();
    const anos=[...new Set(files.map(f=> f.slice(3,7)))].sort();
    const porAno=anos.map(a=>({ano:a, entradas:0, sa√≠das:0}));
    const allTrans=[];
    for(const f of files){
      try{ const fh=await salvarDirHandle.getFileHandle(f,{create:false}); const arr=await fileReadXlsx(fh); const ano=f.slice(3,7); const idx=porAno.findIndex(x=>x.ano===ano); arr.forEach(t=>{ porAno[idx].entradas+=t.entrada; porAno[idx].sa√≠das+=t.saida; allTrans.push({...t}); }); }catch{}
    }
    // Atualiza escopo para Todos e reflete nas tabelas principais
    setScope('all', allTrans);
    renderAll();
    const $tb=$('#tblTodosAnos tbody').empty(); let tE=0,tS=0; porAno.forEach(r=>{ tE+=r.entradas; tS+=r.sa√≠das; const d=r.entradas-r.sa√≠das; const cls=d>=0?'text-success':'text-danger'; $tb.append(`<tr><td><strong>${r.ano}</strong></td><td class='text-end text-success'>${fmtMoney(r.entradas)}</td><td class='text-end text-danger'>${fmtMoney(r.sa√≠das)}</td><td class='text-end ${cls} fw-bold'>${fmtMoney(d)}</td></tr>`); }); $('#tblTodosAnos tfoot').html(`<tr><th class='text-end'>Totais:</th><th class='text-end text-success'>${fmtMoney(tE)}</th><th class='text-end text-danger'>${fmtMoney(tS)}</th><th class='text-end fw-bold'>${fmtMoney(tE-tS)}</th></tr>`); $('#anoInfo').text(`Todos os anos: ${fmtMoney(tE)} entradas / ${fmtMoney(tS)} sa√≠das`);
    $('#secaoTodos').show();
  }
  async function exportarAnoXLSX(ano){
    if(!salvarDirHandle){ return Swal.fire({icon:'info',title:'Selecione a pasta salvar'}); }
    
    try{
      if(typeof ExcelJS==='undefined' || !ExcelJS.Workbook) throw new Error('ExcelJS n√£o dispon√≠vel');
      
      const wb = new ExcelJS.Workbook();
      wb.creator = 'Controle Financeiro';
      wb.created = new Date();
      
      const HEADER_STYLE = (cell)=>{
        cell.font = { bold:true, color:{argb:'FFFFFFFF'}, size:11 };
        cell.fill = { type:'pattern', pattern:'solid', fgColor:{argb:'FF2C5F8D'} };
        cell.alignment = { vertical:'middle', horizontal:'center' };
        cell.border = { top:{style:'thin',color:{argb:'FF000000'}}, bottom:{style:'thin',color:{argb:'FF000000'}}, left:{style:'thin',color:{argb:'FF000000'}}, right:{style:'thin',color:{argb:'FF000000'}} };
      };
      
      const CELL_BORDER = {
        top:{style:'thin',color:{argb:'FFD3D3D3'}},
        bottom:{style:'thin',color:{argb:'FFD3D3D3'}},
        left:{style:'thin',color:{argb:'FFD3D3D3'}},
        right:{style:'thin',color:{argb:'FFD3D3D3'}}
      };
      
      const mesesNomes = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      
      for(let m=1;m<=12;m++){
        const fname=`${String(m).padStart(2,'0')}-${ano}.xlsx`;
        try{
          const fh=await salvarDirHandle.getFileHandle(fname,{create:false});
          const arr=await fileReadXlsx(fh);
          if(arr.length === 0) continue;
          
          const ws = wb.addWorksheet(mesesNomes[m-1]);
          ws.columns = [
            {header:'Data', key:'data', width:14},
            {header:'Descri√ß√£o', key:'desc', width:40},
            {header:'Categoria', key:'cat', width:20},
            {header:'Entrada (+)', key:'ent', width:18},
            {header:'Sa√≠da (-)', key:'sai', width:18}
          ];
          
          // Formatar data brasileiro
          arr.forEach(t=>{
            const [y,m,d] = String(t.data).slice(0,10).split('-');
            const dataFormatada = `${d}/${m}/${y}`;
            ws.addRow([dataFormatada, t.descricao, t.categoria, Number(t.entrada||0), Number(t.saida||0)]);
          });
          
          ws.getRow(1).eachCell(HEADER_STYLE);
          ws.getRow(1).height = 22;
          ws.getColumn(4).numFmt = '"R$ "#,##0.00';
          ws.getColumn(5).numFmt = '"R$ "#,##0.00';
          ws.getColumn(1).alignment = {horizontal:'center', vertical:'middle'};
          ws.getColumn(2).alignment = {horizontal:'left', vertical:'middle'};
          ws.getColumn(3).alignment = {horizontal:'center', vertical:'middle'};
          ws.getColumn(4).alignment = {horizontal:'right', vertical:'middle'};
          ws.getColumn(5).alignment = {horizontal:'right', vertical:'middle'};
          ws.eachRow((row, rowNumber) => { if(rowNumber > 1) row.eachCell(cell => cell.border = CELL_BORDER); });
        }catch{ /* ignore missing month */ }
      }
      
      const buf = await wb.xlsx.writeBuffer();
      const blob = new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`ANO-${ano}.xlsx`; a.click(); URL.revokeObjectURL(a.href);
      Swal.fire({icon:'success',title:`Ano ${ano} exportado!`,timer:1500,showConfirmButton:false});
    }catch(err){
      console.warn('ExcelJS falhou, usando SheetJS', err);
      // Fallback SheetJS sem ID
      const wb=XLSX.utils.book_new();
      for(let m=1;m<=12;m++){
        const fname=`${String(m).padStart(2,'0')}-${ano}.xlsx`;
        try{ 
          const fh=await salvarDirHandle.getFileHandle(fname,{create:false}); 
          const arr=await fileReadXlsx(fh); 
          const aoa=[['Data','Descri√ß√£o','Categoria','Entrada (+)','Sa√≠da (-)'], ...arr.map(t=>[t.data,t.descricao,t.categoria,t.entrada,t.saida])]; 
          const ws=XLSX.utils.aoa_to_sheet(aoa); 
          XLSX.utils.book_append_sheet(wb, ws, `${String(m).padStart(2,'0')}`); 
        }catch{ /* ignore */ }
      }
      const buf=XLSX.write(wb,{bookType:'xlsx',type:'array'}); 
      const blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}); 
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`ANO-${ano}.xlsx`; a.click(); URL.revokeObjectURL(a.href);
    }
  }
  async function exportarTodosAnosXLSX(){
    if(!salvarDirHandle){ return Swal.fire({icon:'info',title:'Selecione a pasta salvar'}); }
    const files=await listarArquivosMes();
    if(files.length===0) return Swal.fire({icon:'info',title:'Nenhum arquivo encontrado'});
    
    try{
      if(typeof ExcelJS==='undefined' || !ExcelJS.Workbook) throw new Error('ExcelJS n√£o dispon√≠vel');
      
      const wb = new ExcelJS.Workbook();
      wb.creator = 'Controle Financeiro';
      wb.created = new Date();
      
      const HEADER_STYLE = (cell)=>{
        cell.font = { bold:true, color:{argb:'FFFFFFFF'}, size:11 };
        cell.fill = { type:'pattern', pattern:'solid', fgColor:{argb:'FF2C5F8D'} };
        cell.alignment = { vertical:'middle', horizontal:'center' };
        cell.border = { top:{style:'thin',color:{argb:'FF000000'}}, bottom:{style:'thin',color:{argb:'FF000000'}}, left:{style:'thin',color:{argb:'FF000000'}}, right:{style:'thin',color:{argb:'FF000000'}} };
      };
      
      const CELL_BORDER = {
        top:{style:'thin',color:{argb:'FFD3D3D3'}},
        bottom:{style:'thin',color:{argb:'FFD3D3D3'}},
        left:{style:'thin',color:{argb:'FFD3D3D3'}},
        right:{style:'thin',color:{argb:'FFD3D3D3'}}
      };
      
      for(const f of files.sort()){
        try{
          const fh=await salvarDirHandle.getFileHandle(f,{create:false});
          const arr=await fileReadXlsx(fh);
          if(arr.length === 0) continue;
          
          const sheetName=f.replace('.xlsx','').slice(0,31);
          const ws = wb.addWorksheet(sheetName);
          ws.columns = [
            {header:'Data', key:'data', width:14},
            {header:'Descri√ß√£o', key:'desc', width:40},
            {header:'Categoria', key:'cat', width:20},
            {header:'Entrada (+)', key:'ent', width:18},
            {header:'Sa√≠da (-)', key:'sai', width:18}
          ];
          
          arr.forEach(t=>{
            const [y,m,d] = String(t.data).slice(0,10).split('-');
            const dataFormatada = `${d}/${m}/${y}`;
            ws.addRow([dataFormatada, t.descricao, t.categoria, Number(t.entrada||0), Number(t.saida||0)]);
          });
          
          ws.getRow(1).eachCell(HEADER_STYLE);
          ws.getRow(1).height = 22;
          ws.getColumn(4).numFmt = '"R$ "#,##0.00';
          ws.getColumn(5).numFmt = '"R$ "#,##0.00';
          ws.getColumn(1).alignment = {horizontal:'center', vertical:'middle'};
          ws.getColumn(2).alignment = {horizontal:'left', vertical:'middle'};
          ws.getColumn(3).alignment = {horizontal:'center', vertical:'middle'};
          ws.getColumn(4).alignment = {horizontal:'right', vertical:'middle'};
          ws.getColumn(5).alignment = {horizontal:'right', vertical:'middle'};
          ws.eachRow((row, rowNumber) => { if(rowNumber > 1) row.eachCell(cell => cell.border = CELL_BORDER); });
        }catch{}
      }
      
      const buf = await wb.xlsx.writeBuffer();
      const blob = new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='TODOS-ANOS.xlsx'; a.click(); URL.revokeObjectURL(a.href);
      Swal.fire({icon:'success',title:'Todos os anos exportados!',timer:1500,showConfirmButton:false});
    }catch(err){
      console.warn('ExcelJS falhou, usando SheetJS', err);
      // Fallback SheetJS sem ID
      const wb=XLSX.utils.book_new();
      for(const f of files.sort()){
        try{ 
          const fh=await salvarDirHandle.getFileHandle(f,{create:false}); 
          const arr=await fileReadXlsx(fh); 
          const aoa=[['Data','Descri√ß√£o','Categoria','Entrada (+)','Sa√≠da (-)'], ...arr.map(t=>[t.data,t.descricao,t.categoria,t.entrada,t.saida])]; 
          const ws=XLSX.utils.aoa_to_sheet(aoa); 
          const sheetName=f.replace('.xlsx','').slice(0,31); 
          XLSX.utils.book_append_sheet(wb, ws, sheetName); 
        }catch{}
      }
      const buf=XLSX.write(wb,{bookType:'xlsx',type:'array'}); 
      const blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}); 
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='TODOS-ANOS.xlsx'; a.click(); URL.revokeObjectURL(a.href);
    }
  }

  async function exportarPorCategoria(){
    if(!salvarDirHandle){ return Swal.fire({icon:'info',title:'Selecione a pasta salvar'}); }
    
    // Mostrar di√°logo para selecionar per√≠odo
    const currentMonthStr = String(currentMonth).padStart(2,'0');
    const currentYearStr = String(currentYear);
    
    const { value: formValues } = await Swal.fire({
      title: 'Exportar por Categoria',
      width: '600px',
      html: `
        <div class="mb-3">
          <label class="form-label fw-bold">M√™s Inicial</label>
          <input type="month" id="mesInicial" class="form-control" value="${currentYearStr}-${currentMonthStr}">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">M√™s Final</label>
          <input type="month" id="mesFinal" class="form-control" value="${currentYearStr}-${currentMonthStr}">
        </div>
        <hr>
        <div class="mb-3">
          <label class="form-label fw-bold">Selecione as Categorias:</label>
          <div style="max-height: 300px; overflow-y: auto; text-align: left; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="checkAll" checked>
              <label class="form-check-label fw-bold" for="checkAll">
                Selecionar Todas
              </label>
            </div>
            <hr style="margin: 8px 0;">
            ${CATEGORIAS.map((cat, idx) => `
              <div class="form-check mb-2">
                <input class="form-check-input cat-checkbox" type="checkbox" id="cat${idx}" value="${cat}" checked>
                <label class="form-check-label" for="cat${idx}">
                  ${cat}
                </label>
              </div>
            `).join('')}
          </div>
        </div>
        <hr>
        <div class="mb-3">
          <label class="form-label fw-bold">Op√ß√£o para Cart√£o de Cr√©dito:</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="creditCardMode" id="ccAll" value="all" checked>
            <label class="form-check-label" for="ccAll">
              Mostrar todos os lan√ßamentos
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="creditCardMode" id="ccParcelas" value="parcelas">
            <label class="form-check-label" for="ccParcelas">
              Mostrar apenas parcelas (compras parceladas)
            </label>
          </div>
        </div>
      `,
      didOpen: () => {
        // L√≥gica para "Selecionar Todas"
        const checkAll = document.getElementById('checkAll');
        const catCheckboxes = document.querySelectorAll('.cat-checkbox');
        
        checkAll.addEventListener('change', function() {
          catCheckboxes.forEach(cb => cb.checked = this.checked);
        });
        
        catCheckboxes.forEach(cb => {
          cb.addEventListener('change', function() {
            const allChecked = Array.from(catCheckboxes).every(c => c.checked);
            checkAll.checked = allChecked;
          });
        });
      },
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: 'Exportar',
      cancelButtonText: 'Cancelar',
      preConfirm: () => {
        const mesInicial = document.getElementById('mesInicial').value;
        const mesFinal = document.getElementById('mesFinal').value;
        if (!mesInicial || !mesFinal) {
          Swal.showValidationMessage('Por favor, preencha ambos os per√≠odos');
          return false;
        }
        if (mesInicial > mesFinal) {
          Swal.showValidationMessage('O m√™s inicial deve ser anterior ou igual ao m√™s final');
          return false;
        }
        
        // Obter categorias selecionadas
        const selectedCategories = Array.from(document.querySelectorAll('.cat-checkbox:checked')).map(cb => cb.value);
        if (selectedCategories.length === 0) {
          Swal.showValidationMessage('Selecione pelo menos uma categoria');
          return false;
        }
        
        const creditCardMode = document.querySelector('input[name="creditCardMode"]:checked').value;
        
        return { mesInicial, mesFinal, selectedCategories, creditCardMode };
      }
    });

    if (!formValues) return;

    const [anoInicial, mesInicial] = formValues.mesInicial.split('-').map(Number);
    const [anoFinal, mesFinal] = formValues.mesFinal.split('-').map(Number);
    const selectedCategories = formValues.selectedCategories;
    const creditCardMode = formValues.creditCardMode;

    // Carregar todos os lan√ßamentos do per√≠odo
    let allTransactions = [];
    let currentDate = new Date(anoInicial, mesInicial - 1, 1);
    const endDate = new Date(anoFinal, mesFinal - 1, 1);

    while (currentDate <= endDate) {
      const ano = currentDate.getFullYear();
      const mes = currentDate.getMonth() + 1;
      const fname = `${String(mes).padStart(2,'0')}-${ano}.xlsx`;
      
      try {
        const fh = await salvarDirHandle.getFileHandle(fname, {create: false});
        const arr = await fileReadXlsx(fh);
        allTransactions = allTransactions.concat(arr);
      } catch(e) {
        // M√™s n√£o existe, pular
      }
      
      currentDate.setMonth(currentDate.getMonth() + 1);
    }

    if (allTransactions.length === 0) {
      return Swal.fire({icon:'info',title:'Nenhum lan√ßamento encontrado no per√≠odo'});
    }

    // Agrupar por categoria (apenas categorias selecionadas)
    const porCategoria = {};
    selectedCategories.forEach(cat => {
      porCategoria[cat] = { entradas: 0, saidas: 0, transacoes: [] };
    });

    allTransactions.forEach(t => {
      // Verificar se a categoria est√° selecionada
      if (!selectedCategories.includes(t.categoria)) return;
      
      // Se for Cart√£o de Cr√©dito e modo parcelas, filtrar apenas parcelas
      if (t.categoria === 'Cart√£o de Cr√©dito' && creditCardMode === 'parcelas') {
        // Verificar se √© uma parcela (descri√ß√£o cont√©m "(X/Y)" no formato das parcelas)
        if (!t.descricao.match(/\(\d+\/\d+\)/)) {
          return; // Pular se n√£o for parcela
        }
      }
      
      porCategoria[t.categoria].entradas += t.entrada || 0;
      porCategoria[t.categoria].saidas += t.saida || 0;
      porCategoria[t.categoria].transacoes.push(t);
    });

    // Verificar se h√° alguma transa√ß√£o nas categorias selecionadas
    const temDados = Object.values(porCategoria).some(d => d.transacoes.length > 0);
    if (!temDados) {
      return Swal.fire({icon:'info',title:'Nenhum lan√ßamento encontrado nas categorias selecionadas'});
    }

    // Exportar usando ExcelJS
    try{
      if(typeof ExcelJS==='undefined' || !ExcelJS.Workbook) throw new Error('ExcelJS n√£o dispon√≠vel');
      
      const wb = new ExcelJS.Workbook();
      wb.creator = 'Controle Financeiro';
      wb.created = new Date();
      
      const HEADER_STYLE = (cell)=>{
        cell.font = { bold:true, color:{argb:'FFFFFFFF'}, size:11 };
        cell.fill = { type:'pattern', pattern:'solid', fgColor:{argb:'FF2C5F8D'} };
        cell.alignment = { vertical:'middle', horizontal:'center' };
        cell.border = { top:{style:'thin',color:{argb:'FF000000'}}, bottom:{style:'thin',color:{argb:'FF000000'}}, left:{style:'thin',color:{argb:'FF000000'}}, right:{style:'thin',color:{argb:'FF000000'}} };
      };
      
      const CELL_BORDER = {
        top:{style:'thin',color:{argb:'FFD3D3D3'}},
        bottom:{style:'thin',color:{argb:'FFD3D3D3'}},
        left:{style:'thin',color:{argb:'FFD3D3D3'}},
        right:{style:'thin',color:{argb:'FFD3D3D3'}}
      };

      // Criar aba de resumo
      const wsResumo = wb.addWorksheet('Resumo por Categoria');
      wsResumo.columns = [
        {header:'Categoria', key:'cat', width:25},
        {header:'Total Entradas', key:'ent', width:18},
        {header:'Total Sa√≠das', key:'sai', width:18},
        {header:'Diferen√ßa', key:'dif', width:18},
        {header:'Qtd. Lan√ßamentos', key:'qtd', width:18}
      ];

      wsResumo.getRow(1).eachCell(cell => HEADER_STYLE(cell));
      wsResumo.getRow(1).height = 25;

      let totalEntradas = 0;
      let totalSaidas = 0;
      let totalLancamentos = 0;

      Object.keys(porCategoria).sort().forEach(cat => {
        const dados = porCategoria[cat];
        if (dados.transacoes.length === 0) return; // Pular categorias vazias
        
        wsResumo.addRow({
          cat: cat,
          ent: dados.entradas,
          sai: dados.saidas,
          dif: dados.entradas - dados.saidas,
          qtd: dados.transacoes.length
        });
        
        totalEntradas += dados.entradas;
        totalSaidas += dados.saidas;
        totalLancamentos += dados.transacoes.length;
      });

      // Linha de totais
      const totalRow = wsResumo.addRow({
        cat: 'TOTAL',
        ent: totalEntradas,
        sai: totalSaidas,
        dif: totalEntradas - totalSaidas,
        qtd: totalLancamentos
      });
      totalRow.font = { bold: true };
      totalRow.fill = { type:'pattern', pattern:'solid', fgColor:{argb:'FFE0E0E0'} };

      // Formatar valores
      wsResumo.getColumn(2).numFmt = 'R$ #,##0.00';
      wsResumo.getColumn(3).numFmt = 'R$ #,##0.00';
      wsResumo.getColumn(4).numFmt = 'R$ #,##0.00';
      
      wsResumo.getColumn(1).alignment = {horizontal:'left', vertical:'middle'};
      wsResumo.getColumn(2).alignment = {horizontal:'right', vertical:'middle'};
      wsResumo.getColumn(3).alignment = {horizontal:'right', vertical:'middle'};
      wsResumo.getColumn(4).alignment = {horizontal:'right', vertical:'middle'};
      wsResumo.getColumn(5).alignment = {horizontal:'center', vertical:'middle'};
      
      wsResumo.eachRow((row, rowNumber) => { 
        if(rowNumber > 1) row.eachCell(cell => cell.border = CELL_BORDER); 
      });

      // Criar aba para cada categoria com lan√ßamentos
      Object.keys(porCategoria).sort().forEach(cat => {
        const dados = porCategoria[cat];
        if (dados.transacoes.length === 0) return; // Pular categorias vazias
        
        const sheetName = cat.slice(0, 31); // Excel limita a 31 caracteres
        const ws = wb.addWorksheet(sheetName);
        
        ws.columns = [
          {header:'Data', key:'data', width:14},
          {header:'Descri√ß√£o', key:'desc', width:40},
          {header:'Entrada (+)', key:'ent', width:18},
          {header:'Sa√≠da (-)', key:'sai', width:18}
        ];

        ws.getRow(1).eachCell(cell => HEADER_STYLE(cell));
        ws.getRow(1).height = 25;

        // Ordenar por data
        dados.transacoes.sort((a,b) => a.data.localeCompare(b.data));

        dados.transacoes.forEach(t => {
          const [ano,mes,dia] = t.data.split('-');
          ws.addRow({
            data: `${dia}/${mes}/${ano}`,
            desc: t.descricao,
            ent: t.entrada || 0,
            sai: t.saida || 0
          });
        });

        // Linha de totais
        const catTotalRow = ws.addRow({
          data: '',
          desc: 'TOTAL',
          ent: dados.entradas,
          sai: dados.saidas
        });
        catTotalRow.font = { bold: true };
        catTotalRow.fill = { type:'pattern', pattern:'solid', fgColor:{argb:'FFE0E0E0'} };

        ws.getColumn(3).numFmt = 'R$ #,##0.00';
        ws.getColumn(4).numFmt = 'R$ #,##0.00';
        
        ws.getColumn(1).alignment = {horizontal:'center', vertical:'middle'};
        ws.getColumn(2).alignment = {horizontal:'left', vertical:'middle'};
        ws.getColumn(3).alignment = {horizontal:'right', vertical:'middle'};
        ws.getColumn(4).alignment = {horizontal:'right', vertical:'middle'};
        
        ws.eachRow((row, rowNumber) => { 
          if(rowNumber > 1) row.eachCell(cell => cell.border = CELL_BORDER); 
        });
      });

      const buf = await wb.xlsx.writeBuffer();
      const blob = new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      const sufixoParcelas = (creditCardMode === 'parcelas' && selectedCategories.includes('Cart√£o de Cr√©dito')) ? '_PARCELAS' : '';
      const fileName = `CATEGORIAS_${String(mesInicial).padStart(2,'0')}-${anoInicial}_a_${String(mesFinal).padStart(2,'0')}-${anoFinal}${sufixoParcelas}.xlsx`;
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); URL.revokeObjectURL(a.href);
      
      let mensagem = 'Exportado por categoria!';
      if (creditCardMode === 'parcelas' && selectedCategories.includes('Cart√£o de Cr√©dito')) {
        mensagem = 'Exportado (apenas parcelas do cart√£o)!';
      }
      Swal.fire({icon:'success',title:mensagem,timer:1500,showConfirmButton:false});
    }catch(err){
      console.error('Erro ao exportar por categoria', err);
      Swal.fire({icon:'error',title:'Erro ao exportar',text:err.message});
    }
  }

  </script>
</body>
</html>
